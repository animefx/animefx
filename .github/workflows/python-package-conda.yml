import os
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackContext, CallbackQueryHandler
from dotenv import load_dotenv

load_dotenv()
TOKEN = os.getenv("TELEGRAM_TOKEN")

# –ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ —á–µ—Ä–µ–∑ Jikan API
def search_anime(query):
    url = f"https://api.jikan.moe/v4/anime?q={query}"
    response = requests.get(url).json()
    return response["data"][0] if response["data"] else None

# –ö–æ–º–∞–Ω–¥–∞ /start
def start(update: Update, context: CallbackContext):
    update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏ /search <–Ω–∞–∑–≤–∞–Ω–∏–µ>, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∞–Ω–∏–º–µ.")

# –ö–æ–º–∞–Ω–¥–∞ /search
def search(update: Update, context: CallbackContext):
    query = " ".join(context.args)
    if not query:
        update.message.reply_text("–ü—Ä–∏–º–µ—Ä: /search –ù–∞—Ä—É—Ç–æ")
        return

    anime = search_anime(query)
    if not anime:
        update.message.reply_text("–ê–Ω–∏–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üò¢")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    title = anime["title"]
    episodes = anime["episodes"]
    score = anime["score"]
    url = anime["url"]
    synopsis = anime["synopsis"][:500] + "..."  # –û–±—Ä–µ–∑–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ

    message = (
        f"üé¨ **{title}**\n"
        f"üì∫ –≠–ø–∏–∑–æ–¥—ã: {episodes}\n"
        f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {score}\n"
        f"üìñ –û–ø–∏—Å–∞–Ω–∏–µ: {synopsis}\n"
        f"[–°—Å—ã–ª–∫–∞ –Ω–∞ MyAnimeList]({url})"
    )

    # –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    keyboard = [[InlineKeyboardButton("‚ù§Ô∏è –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", callback_data=f"fav_{anime['mal_id']}")]]
    update.message.reply_markdown(message, reply_markup=InlineKeyboardMarkup(keyboard))

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫
def button_handler(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    anime_id = query.data.split("_")[1]
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å anime_id –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    query.edit_message_text(text="–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ! ‚úÖ")

def main():
    updater = Updater(TOKEN)
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("search", search))
    dispatcher.add_handler(CallbackQueryHandler(button_handler))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
